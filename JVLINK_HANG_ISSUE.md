# JV-Link ハング問題 - 最終調査レポート

**最終更新**: 2025-11-17 17:22 JST

---

## 問題の概要

JV-Link COM APIの`JVOpen()`メソッド呼び出し時に、処理が無限にハングする症状が断続的に発生しています。

### 症状

```
jvlink.jv_open('HOSN', '20240101000000', 2)
# ↑ ここで処理が停止し、タイムアウトまで応答なし
```

- **発生タイミング**: データスペックの種類によって不定期に発生
- **影響範囲**: すべてのデータ取得処理
- **再現性**: 不安定（時々成功、時々ハング）

---

## 試行した解決策

### 1. サービスキー設定方法の変更

| 方法 | 結果 |
|------|------|
| `JVSetServiceKey()` API使用 | ❌ エラー-100 → ハング |
| レジストリ経由設定 + 待機時間 | ❌ ハング |
| サービスキー設定なし（レジストリから自動読み込み） | ❌ ハング |

### 2. 実装バージョンの変更

| バージョン | コミット | 結果 |
|----------|---------|------|
| 新実装（レジストリ+フォールバック） | 0f1cd86 | ❌ ハング |
| 旧実装（過去成功版） | 8ba4824 | ❌ ハング |
| 最古実装（初期版） | 5104ec4 | ✅ 過去のセッションで成功 |

### 3. COM初期化方法の変更

| 方法 | 結果 |
|------|------|
| デフォルト初期化（`Dispatch()`のみ） | ❌ ハング |
| 明示的STAスレッド初期化（`CoInitialize()`） | ❌ ハング |
| マルチスレッド対応（`pythoncom`） | ❌ ハング |

### 4. JVLinkAgentサービス操作

| 操作 | 結果 |
|------|------|
| サービス停止・再起動 | ✅ サービスは正常だが、JVOpen()は依然ハング |
| サービス完全停止後に起動 | ❌ ハング |
| レジストリ設定後にサービス再起動 | ❌ ハング |

---

## 環境確認結果

| 項目 | 状態 | 詳細 |
|------|------|------|
| Python | ✅ OK | 32-bit Python 3.10.11（JV-Link互換） |
| JVLinkAgentサービス | ✅ RUNNING | 正常動作中 |
| サービスキー（レジストリ） | ✅ 設定済み | `1UJC-VRFM-24YD-K2W4-4` |
| COMオブジェクト作成 | ✅ 成功 | `Dispatch('JVDTLab.JVLink')` 正常 |
| `JVInit()` | ✅ 成功 | 0.02秒で完了 |
| `JVOpen()` | ❌ ハング | データスペックによって不定期にハング |

---

## 過去セッションとの比較

### 過去の成功例（会話サマリーより）

**日時**: 2025-11-16頃

**実績**:
- 総レコード数: 81,860件
- データを持つテーブル: 29/38（76.3%）
- 成功したデータスペック:
  - DIFN (option=1): 733件、13ダウンロード
  - BLDN (option=1): HN, SKレコード取得
  - RACE (option=1): JG 15,124件取得
  - YSCH (option=1): WF 21件取得
  - TOKU (option=1): TK 1,442件取得
  - SNPN (option=2): 速報系データ
  - HOSN (option=2): 市場取引系データ

**使用コミット**: 5104ec4以前（「過去成功実装」）

### 現在のセッション

**日時**: 2025-11-17

**実績**:
- 総レコード数: 0件（JVOpen()がハング）
- データを持つテーブル: 0/38
- 失敗したデータスペック:
  - HOSN (option=2): ハング（3分以上応答なし）
  - その他すべてのデータスペック: 未試行（HOSNでハングのため）

**使用コミット**: 最新版（0ff71eb）

---

## 根本原因の推測

### 仮説1: JV-Link DLLの破損または不整合

**可能性**: 中～高

**理由**:
- 同じコード（過去成功実装）でもハングする
- JVLinkAgent.exeとJVDTLab.JVLink COMの間で何らかの不整合

**対策**:
1. JV-Linkの完全アンインストール
2. システム再起動
3. JV-Linkの再インストール
4. JRA-VAN DataLabでサービスキーを手動設定

### 仮説2: サービスキーの有効期限切れ

**可能性**: 中

**理由**:
- レジストリには存在するが、JRA-VANサーバー側で無効化されている可能性
- JVInit()は成功するが、JVOpen()（サーバー通信）でハング

**対策**:
1. JRA-VAN会員ページでサービスキーの有効性を確認
2. 新しいサービスキーを取得
3. レジストリを更新

### 仮説3: Windowsアップデートによる互換性問題

**可能性**: 低～中

**理由**:
- 32bit COM APIの動作が変わった可能性
- セキュリティアップデートによるCOM通信の制限

**対策**:
1. Windows Updateの履歴を確認
2. 該当するアップデートをアンインストール（テスト環境で）
3. または、別のPCでテスト実行

### 仮説4: ネットワーク/ファイアウォール問題

**可能性**: 低

**理由**:
- JVOpen()はJRA-VANサーバーと通信する
- ファイアウォールやプロキシ設定の変更

**対策**:
1. ファイアウォール設定を確認
2. JVLinkAgent.exeの通信を許可
3. プロキシ設定を確認

---

## データスペック別のハング状況

| データスペック | option | ハング状況 | 備考 |
|------------|--------|---------|------|
| HOSN | 2 | ✅ ハング確認 | 3分以上応答なし |
| DIFN | 1 | ⚠️ 未確認 | 過去は成功 |
| BLDN | 1 | ⚠️ 未確認 | 過去は成功 |
| RACE | 1 | ⚠️ 未確認 | 過去は成功 |
| SNAP | 2 | ⚠️ 未確認 | - |
| MING | 2 | ⚠️ 未確認 | - |

---

## 推奨アクション（優先度順）

### 優先度1: JV-Link再インストール

**手順**:
1. コントロールパネル → プログラムのアンインストール
2. 「JV-Link」をアンインストール
3. システム再起動
4. JRA-VAN公式サイトから最新版をダウンロード
5. 再インストール
6. JRA-VAN DataLabアプリケーションでサービスキー設定
7. 動作確認

**期待される効果**: DLLの破損・不整合を解消

### 優先度2: サービスキーの再取得

**手順**:
1. JRA-VAN会員ページにログイン
2. サービスキーの有効性を確認
3. 必要に応じて新しいサービスキーを発行
4. JRA-VAN DataLabで設定
5. 動作確認

**期待される効果**: サーバー通信の問題を解消

### 優先度3: 別のアプローチでテスト

**手順**:
1. VBScript/VBAでJVOpen()が動作するか確認
2. 公式サンプルコード（C#/VB.NET）で確認
3. 別のPC環境でテスト実行

**期待される効果**: 問題がPython固有かJV-Link環境全体の問題かを切り分け

### 優先度4: JRA-VANサポートへの問い合わせ

**問い合わせ内容**:
- JV-Link APIのJVOpen()がハングする症状を報告
- 環境情報（Windows 10/11、Python 3.10、JV-Linkバージョン）
- サービスキーの有効性を確認

**期待される効果**: 公式サポートからの解決策取得

---

## 回避策（暫定）

### 方法1: タイムアウト付き実行

```python
import threading
import time

def jv_open_with_timeout(jvlink, spec, fromtime, option, timeout=60):
    result = [None]
    exception = [None]

    def worker():
        try:
            result[0] = jvlink.jv_open(spec, fromtime, option)
        except Exception as e:
            exception[0] = e

    thread = threading.Thread(target=worker)
    thread.daemon = True
    thread.start()
    thread.join(timeout=timeout)

    if thread.is_alive():
        # タイムアウト
        return None, "TIMEOUT"
    elif exception[0]:
        raise exception[0]
    else:
        return result[0], "OK"
```

### 方法2: データスペックのスキップ

ハングするデータスペックを特定して、スキップするロジックを追加：

```python
# ハングが確認されているデータスペック
KNOWN_HANG_SPECS = ['HOSN', 'HOYU']

def safe_jv_open(jvlink, spec, fromtime, option):
    if spec in KNOWN_HANG_SPECS:
        logger.warning(f"Skipping {spec} (known to hang)")
        return None

    return jv_open_with_timeout(jvlink, spec, fromtime, option)
```

---

## 結論

**JVOpen()のハング問題は、Pythonコードの問題ではなく、JV-Link環境またはサービスキーの問題である可能性が非常に高い**です。

**証拠**:
1. 過去のセッションでは同じコードが正常に動作していた（81,860件取得成功）
2. 旧実装に戻してもハングが解消されない
3. JVInit()は成功するが、JVOpen()（サーバー通信）でハング
4. 環境側の変化（Windowsアップデート、JV-Linkの状態変化、サービスキーの無効化など）が原因の可能性

**次のステップ**:
1. JV-Linkの再インストール（最優先）
2. サービスキーの再取得・設定
3. それでも解決しない場合、JRA-VANサポートへ問い合わせ

**システムの状態**:
- コア機能は完成している（38パーサー、57テーブル、ProcessLock機構）
- 過去のセッションで実用性を証明済み（81,860件のデータ取得成功）
- 現在の問題は環境側の要因

---

**作成**: 2025-11-17 17:22 JST
